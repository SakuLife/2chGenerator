name: Cancel Stale Runs

on:
  schedule:
    # 毎時チェック
    - cron: '30 * * * *'
  workflow_dispatch:

jobs:
  cancel-stale:
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - name: Cancel runs waiting too long
        uses: actions/github-script@v7
        with:
          script: |
            const MAX_WAIT_MINUTES = 30;
            const now = Date.now();

            const runs = await github.rest.actions.listWorkflowRunsForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              status: 'queued',
              per_page: 50,
            });

            for (const run of runs.data.workflow_runs) {
              const createdAt = new Date(run.created_at).getTime();
              const waitMinutes = (now - createdAt) / 60000;

              if (waitMinutes > MAX_WAIT_MINUTES) {
                console.log(`Cancelling run #${run.id} (${run.name}) - waiting ${Math.round(waitMinutes)} min`);
                await github.rest.actions.cancelWorkflowRun({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  run_id: run.id,
                });
              }
            }
